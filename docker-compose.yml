services:
  # ============================================================================
  # DATABASES
  # ============================================================================
  
  # PostgreSQL - Primary relational database (Phase 1: Core Database)
  postgres:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-erp_system}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-erp_system}"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack

  # MongoDB - Analytics, logs, AI conversations (Phase 2: Document Store)
  mongodb:
    image: mongo:6-jammy
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-erp_analytics}
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--username", "${MONGODB_ROOT_USERNAME:-root}", "--password", "${MONGODB_ROOT_PASSWORD:-password}", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack

  # Redis - Cache, sessions, queues
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redispassword}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack

  # Qdrant - Vector database for AI/RAG
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-qdrant
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - ai-services

  # ============================================================================
  # MESSAGE BROKERS
  # ============================================================================

  # Kafka - Event streaming (KRaft mode - optimized for macOS)
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-kafka
    environment:
      # KRaft Configuration
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:${KAFKA_INTERNAL_PORT:-29092},PLAINTEXT_HOST://0.0.0.0:${KAFKA_PORT:-9092},CONTROLLER://0.0.0.0:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:${KAFKA_INTERNAL_PORT:-29092},PLAINTEXT_HOST://localhost:${KAFKA_PORT:-9092}
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      
      # Topic Configuration (optimized for development)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 1
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      
      # Log Configuration (reduced for faster startup)
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_LOG_RETENTION_HOURS: 24
      KAFKA_LOG_SEGMENT_BYTES: 268435456
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 600000
      
      # Performance Configuration (optimized for macOS)
      KAFKA_NUM_NETWORK_THREADS: 2
      KAFKA_NUM_IO_THREADS: 4
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 65536
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 65536
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 52428800
      
      # Memory optimization
      KAFKA_HEAP_OPTS: "-Xmx256m -Xms256m"
      
      # Cluster Configuration
      CLUSTER_ID: ${KAFKA_CLUSTER_ID:-MkU3OEVBNTcwNTJENDM2Qk}
    ports:
      - "${KAFKA_PORT:-9092}:${KAFKA_PORT:-9092}"
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:${KAFKA_PORT:-9092} | grep -q 'ApiVersion' || exit 1"]
      interval: 45s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack

  # ============================================================================
  # SEARCH & ANALYTICS
  # ============================================================================

  # Elasticsearch - Full-text search (optimized for macOS)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=${ELASTICSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}"
      - bootstrap.memory_lock=false
      - cluster.routing.allocation.disk.threshold_enabled=false
      - xpack.security.transport.ssl.enabled=false
      - xpack.security.http.ssl.enabled=false
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 512m
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=5s || exit 1"]
      interval: 45s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack

  # Kibana - Elasticsearch UI
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-kibana
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      XPACK_SECURITY_ENABLED: false
      XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY: ${KIBANA_ENCRYPTION_KEY:-a7a6311933d3503b89bc2dbc36572c01a6b9c9b0ba6d6b6b6b6b6b6b6b6b6b6b}
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - logging

  # ============================================================================
  # API GATEWAY & COMMUNICATION LAYER
  # ============================================================================

  # GraphQL Gateway (Apollo Server + Express)
  graphql-gateway:
    image: node:18-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-graphql-gateway
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379
      POSTGRES_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-erp_system}
      GRPC_AUTH_SERVICE: auth-service:${GRPC_AUTH_PORT:-50051}
      GRPC_CRM_SERVICE: crm-service:${GRPC_CRM_PORT:-50052}
      GRPC_HRM_SERVICE: hrm-service:${GRPC_HRM_PORT:-50053}
      GRPC_FINANCE_SERVICE: finance-service:${GRPC_FINANCE_PORT:-50054}
      GRPC_INVENTORY_SERVICE: inventory-service:${GRPC_INVENTORY_PORT:-50055}
      GRPC_PROJECT_SERVICE: project-service:${GRPC_PROJECT_PORT:-50056}
      PORT: ${GRAPHQL_GATEWAY_PORT:-4000}
      ENABLE_PLAYGROUND: ${GRAPHQL_ENABLE_PLAYGROUND:-true}
      ENABLE_INTROSPECTION: ${GRAPHQL_ENABLE_INTROSPECTION:-true}
      QUERY_CACHE_TTL: ${GRAPHQL_QUERY_CACHE_TTL:-300}
      DATALOADER_CACHE_TTL: ${GRAPHQL_DATALOADER_CACHE_TTL:-60}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${GRAPHQL_GATEWAY_PORT:-4000}:${GRAPHQL_GATEWAY_PORT:-4000}"
    volumes:
      - ./graphql-gateway:/app
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${GRAPHQL_GATEWAY_PORT:-4000}/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - api-layer

  # gRPC Service Registry & Load Balancer (Consul)
  grpc-registry:
    image: consul:1.15
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-grpc-registry
    command: consul agent -dev -client=0.0.0.0 -ui
    environment:
      CONSUL_BIND_INTERFACE: eth0
    ports:
      - "${CONSUL_PORT:-8500}:8500"
      - "${CONSUL_DNS_PORT:-8600}:8600/udp"
    volumes:
      - consul_data:/consul/data
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - api-layer

  # WebSocket Server (Node.js with Socket.IO) - Enhanced for GraphQL subscriptions
  websocket-server:
    image: node:18-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-websocket
    working_dir: /app
    command: sh -c "npm install && npm start"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379
      GRAPHQL_GATEWAY_URL: http://graphql-gateway:${GRAPHQL_GATEWAY_PORT:-4000}/graphql
      PORT: ${WEBSOCKET_PORT:-3001}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${WEBSOCKET_PORT:-3001}:${WEBSOCKET_PORT:-3001}"
    volumes:
      - ./websocket-server:/app
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${WEBSOCKET_PORT:-3001}/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - api-layer

  # ============================================================================
  # REVERSE PROXY (NGINX)
  # ============================================================================
  
  # NGINX Reverse Proxy - Main entry point for external traffic
  nginx-proxy:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-nginx-proxy
    network_mode: "host"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - graphql-gateway
      - api-gateway
      - websocket-server
      - erp-frontend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - full-stack
      - proxy

  # ============================================================================
  # SIMPLE LOGGING
  # ============================================================================
  # Note: Monitoring services (Prometheus, Grafana, Jaeger) have been removed
  # Only keeping Kibana for simple log visualization

  # ============================================================================
  # DEVELOPMENT TOOLS
  # ============================================================================

  # pgAdmin - PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:8.0
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@erp.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-8081}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./config/pgadmin/servers.json:/pgadmin4/servers.json
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/misc/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - dev-tools

  # Mongo Express - MongoDB management
  mongo-express:
    image: mongo-express:1.0.0-alpha
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-mongo-express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_ROOT_USERNAME:-root}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGODB_ROOT_PASSWORD:-password}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGODB_ROOT_USERNAME:-root}:${MONGODB_ROOT_PASSWORD:-password}@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USERNAME:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-pass}
    ports:
      - "${MONGO_EXPRESS_PORT:-8082}:8081"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - dev-tools

  # Redis Commander - Redis management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-redispassword}
    ports:
      - "${REDIS_COMMANDER_PORT:-8083}:8081"
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - dev-tools

  # Kafka UI - Kafka management (KRaft mode compatible)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-kafka-ui
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:${KAFKA_INTERNAL_PORT:-29092}
      # Note: Zookeeper configuration removed for KRaft mode
      DYNAMIC_CONFIG_ENABLED: 'true'
      LOGGING_LEVEL_COM_PROVECTUS: DEBUG
    ports:
      - "${KAFKA_UI_PORT:-8084}:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - erp-network
    profiles:
      - infrastructure
      - full-stack
      - dev-tools

  # ============================================================================
  # APPLICATION SERVICES (Full Stack Profile)
  # ============================================================================

  # Auth Service (Go) - Authentication and Authorization
  auth-service:
    build:
      context: ../erp-auth-service
      dockerfile: Dockerfile.dev
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-auth-service
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: erp_auth
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DB_SSL_MODE: disable
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
      REDIS_DB: 0
      
      # Kafka Configuration
      KAFKA_BROKERS: kafka:${KAFKA_INTERNAL_PORT:-29092}
      KAFKA_GROUP_ID: auth-service-group
      
      # Service Configuration
      PORT: ${AUTH_SERVICE_HTTP_PORT:-8080}
      GRPC_PORT: ${AUTH_SERVICE_GRPC_PORT:-50051}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_ACCESS_EXPIRY: 3600
      JWT_REFRESH_EXPIRY: 604800
      
      # Kafka Topic Configuration
      KAFKA_TOPIC: auth-events
      
      # Server Configuration
      GIN_MODE: debug
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:4000
      
      # Environment
      ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
    ports:
      - "${AUTH_SERVICE_HTTP_PORT:-8080}:${AUTH_SERVICE_HTTP_PORT:-8080}"   # HTTP API
      - "${AUTH_SERVICE_GRPC_PORT:-50051}:${AUTH_SERVICE_GRPC_PORT:-50051}" # gRPC API
    volumes:
      - ../erp-auth-service:/src
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AUTH_SERVICE_HTTP_PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - erp-network
    profiles:
      - full-stack

  # Django API Gateway - Main API Gateway
  api-gateway:
    build:
      context: ../erp-api-gateway
      dockerfile: Dockerfile.dev
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-api-gateway
    command: >
      sh -c "python manage.py migrate && gunicorn erp_core.wsgi:application --bind 0.0.0.0:8000"
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: erp_system
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
      REDIS_DB: 1
      
      # Kafka Configuration
      KAFKA_BROKERS: kafka:${KAFKA_INTERNAL_PORT:-29092}
      KAFKA_GROUP_ID: django-api-gateway-group
      
      # Elasticsearch Configuration
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTIC_PASSWORD:-password}
      
      # MongoDB Configuration
      MONGODB_HOST: mongodb
      MONGODB_PORT: 27017
      MONGODB_USERNAME: ${MONGODB_ROOT_USERNAME:-root}
      MONGODB_PASSWORD: ${MONGODB_ROOT_PASSWORD:-password}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-erp_analytics}
      
      # Auth Service Configuration
      AUTH_SERVICE_HTTP_URL: http://auth-service:${AUTH_SERVICE_HTTP_PORT:-8080}
      AUTH_SERVICE_GRPC_HOST: auth-service
      AUTH_SERVICE_GRPC_PORT: ${AUTH_SERVICE_GRPC_PORT:-50051}
      
      # WebSocket Configuration
      WEBSOCKET_URL: http://websocket-server:${WEBSOCKET_PORT:-3001}
      
      # Django Configuration
      DEBUG: ${DJANGO_DEBUG:-true}
      SECRET_KEY: ${DJANGO_SECRET_KEY:-your-super-secret-django-key-change-in-production}
      ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1,api-gateway}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://erp-frontend:3000}
      
      # Environment
      ENV: ${NODE_ENV:-development}
    ports:
      - "${DJANGO_PORT:-8000}:8000"
    volumes:
      - ../erp-api-gateway:/src
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - erp-network
    profiles:
      - full-stack

  # Next.js Frontend - Main Web Application
  erp-frontend:
    build:
      context: ../erp-frontend
      dockerfile: Dockerfile.dev
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-frontend
    environment:
      # API Configuration (using container names for internal communication)
      NEXT_PUBLIC_API_URL: ${EXTERNAL_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_GRAPHQL_URL: ${EXTERNAL_GRAPHQL_URL:-http://localhost:4000/graphql}
      NEXT_PUBLIC_WS_URL: ${EXTERNAL_WS_URL:-http://localhost:3001}
      
      # Auth Configuration
      NEXT_PUBLIC_AUTH_URL: http://localhost:${AUTH_SERVICE_HTTP_PORT:-8080}
      NEXTAUTH_URL: http://localhost:${FRONTEND_PORT:-3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-your-super-secret-nextauth-key-change-in-production}
      
      # Environment
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}
      
      # Fix for file watching in Docker
      WATCHPACK_POLLING: true
      CHOKIDAR_USEPOLLING: true
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ../erp-frontend:/app
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
    depends_on:
      api-gateway:
        condition: service_healthy
      graphql-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - erp-network
    profiles:
      - full-stack

  log-service:
    build:
      context: ../erp-log-viewer-service
      dockerfile: Dockerfile.dev
    container_name: ${COMPOSE_PROJECT_NAME:-erp-suite}-log-service
    ports:
      - "${LOG_SERVICE_HTTP_PORT:-8001}:8001"
      - "${LOG_SERVICE_GRPC_PORT:-50052}:50052"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-erp_system}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      KAFKA_BROKERS: kafka:${KAFKA_INTERNAL_PORT:-29092}
      AUTH_SERVICE_GRPC_HOST: auth-service
      AUTH_SERVICE_GRPC_PORT: ${AUTH_SERVICE_GRPC_PORT:-50051}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      HTTP_PORT: 8001
      GRPC_PORT: 50052
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - ../erp-log-viewer-service:/app
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
    networks:
      - erp-network
    profiles:
      - full-stack

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  qdrant_data:
  kafka_data:
  elasticsearch_data:
  pgadmin_data:
  consul_data:
  frontend_node_modules:
  frontend_next:

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  erp-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.20.0.0/16}
